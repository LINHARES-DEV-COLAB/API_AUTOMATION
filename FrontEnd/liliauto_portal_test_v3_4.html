<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LiLi Auto ‚Ä¢ Portal (HTML Test Harness v3.5)</title>
  <style>
    :root{ --bg:#0f172a; --card:#0b1227; --text:#e5e7eb; --muted:#94a3b8;
      --brand:#22d3ee; --surface:#111827; --shadow:0 10px 30px rgba(0,0,0,.25); --radius:16px; }
    *{box-sizing:border-box}
    body{margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      background:var(--bg); color:var(--text);}
    .wrap{display:flex; flex-direction:column; min-height:100dvh}
    header{background:#0b1227; box-shadow:var(--shadow)}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:24px; padding:16px 24px; max-width:1280px; margin:auto}
    .logo{display:flex; align-items:center; gap:12px}
    .logo img{height:40px}
    .controls{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .input, select, button, textarea{border-radius:8px; border:1px solid #26324e; background:#0a1224; color:var(--text); outline:none}
    .input, select, button{height:40px; padding:0 12px;}
    textarea{padding:12px; min-height:90px; resize:vertical}
    .input::placeholder, textarea::placeholder{color:#64748b}
    button{border:none; background:var(--brand); color:#001018; font-weight:700; cursor:pointer}
    button.ghost{background:#7a8086aa; color:var(--text)}
    button:disabled{opacity:.5; cursor:not-allowed}
    .divider{height:9px; background:var(--brand)}
    main{flex:1; background: radial-gradient(1200px 1200px at 120% -20%, #133b47 0%, transparent 45%)}
    .container{max-width:1280px; margin:0 auto; padding:24px}
    .row{display:flex; gap:24px; flex-wrap:wrap; justify-content:center}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:24px}
    .card h3{margin:0 0 8px 0; font-size:16px}
    .hr{height:2px; background:var(--brand); width:40%; margin:0 0 16px 0}
    .w-30{width:min(420px, 100%)}
    .w-68{width:min(870px, 100%)}
    .w-80{width:min(1024px, 100%)}
    .logbox{background:var(--surface); border-radius:12px; padding:16px; height:140px; overflow:auto; border:1px solid #1f2937;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px}
    .flex{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .checkbox-col{columns:2; column-gap:24px}
    .checkbox-col label{break-inside:avoid; margin-bottom:6px; font-size:14px; color:#cbd5e1; display:flex; gap:8px; align-items:center}
    .hidden{display:none !important}
    footer{background:#1f2937aa; color:var(--text)}
    .footer-in{display:flex; align-items:center; justify-content:space-between; gap:24px; padding:12px 24px; max-width:1280px; margin:auto; flex-wrap:wrap}
    .pill{display:inline-block; padding:4px 8px; border:1px solid #334155; border-radius:999px; color:#cbd5e1; font-size:12px}
    a.link{color:var(--brand); text-decoration:none}
    small.helper{display:block; color:#94a3b8; margin-top:4px}
    .filebox{background:#0a1224; border:1px dashed #334155; padding:12px; border-radius:10px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="topbar">
      <div class="logo">
        <img src="https://dummyimage.com/160x40/0b1227/22d3ee.png&text=LiLi+Auto" alt="LiLi Auto"/>
        <span class="pill">Portal (HTML Test v3.5)</span>
      </div>
      <div class="controls">
        <input id="userInput" class="input" placeholder="usu√°rio (ex.: nome.sobrenome)" value="nome.sobrenome"/>
        <input id="baseUrl" class="input" style="min-width:320px" placeholder="Base URL da API (ex.: http://127.0.0.1:5000)" value="http://127.0.0.1:5000"/>
        <input id="jwt" class="input" style="min-width:320px" placeholder="JWT (somente o token)"/>
        <button id="btnSave">Salvar</button>
        <button id="btnLogout" class="ghost">Sair</button>
      </div>
    </div>
    <div class="divider"></div>
  </header>

  <main>
    <div class="container">

      <div class="row">
        <div class="card w-30">
          <h3>√Årea de Neg√≥cio</h3>
          <div class="hr"></div>
          <select id="departments" disabled>
            <option value="">Carregando...</option>
          </select>
          <small class="helper">GET <code>/toFront/departments</code></small>
        </div>

        <div class="card w-30">
          <h3>Automa√ß√µes</h3>
          <div class="hr"></div>
          <select id="automations" disabled>
            <option value="">Selecione a √°rea</option>
          </select>
          <input id="automationsPath" class="input" value="/toFront/automations" style="margin-top:12px"/>
          <small class="helper">GET <code>/toFront/automations/{department_id}</code></small>
        </div>
      </div>

      <div class="row">
        <div class="card w-68">
          <h3>Execu√ß√£o</h3>
          <div class="hr"></div>

          <div class="grid2">
            <div>
              <label class="pill">Endpoint de execu√ß√£o</label>
              <div class="input" id="execEndpoint" style="height:auto; padding:10px; margin-top:6px">
                <code>Selecione uma automa√ß√£o</code>
              </div>
              <small class="helper" id="endpointHelper">Endpoint ser√° definido pela automa√ß√£o selecionada</small>
            </div>
            <div>
              <label class="pill">Par√¢metros extras (key=value por linha)</label>
              <textarea id="extraParams" placeholder="ex.: ref_date=2025-11-05&#10;mode=full"></textarea>
              <small class="helper">Ser√£o enviados no <code>FormData</code> conforme necess√°rio.</small>
            </div>
          </div>

          <div class="grid2" style="margin-top:12px">
            <div class="filebox">
              <label class="pill">Arquivos (m√∫ltiplos)</label><br/>
              <input id="fileInput" type="file" multiple />
              <small class="helper">
                Para algumas automa√ß√µes espec√≠ficas que requerem upload de arquivos.
              </small>
            </div>
            <div>
              <div class="pill" style="display:inline-block; margin-bottom:8px">Resumo</div>
              <div id="execInfo" class="logbox" style="height:120px"></div>
            </div>
          </div>

          <!-- Blocos espec√≠ficos para cada tipo de automa√ß√£o -->
          <div id="blkCDC" class="card hidden" style="background:#0a1224; margin-top:16px">
            <h4 style="margin:0 0 12px 0">Concilia√ß√£o CDC Honda ‚Äì Filiais</h4>
            <div class="checkbox-col" id="cdcChecks"></div>
            <div class="flex" style="margin-top:16px">
              <button id="cdcSelectAll">Selecionar Todos</button>
              <button id="cdcClear" class="ghost">Desmarcar Todos</button>
            </div>
          </div>

          <div id="blkCNH" class="card hidden" style="background:#0a1224; margin-top:16px">
            <h4 style="margin:0 0 12px 0">Baixas CNH Honda ‚Äì Filiais</h4>
            <div class="checkbox-col" id="cnhChecks"></div>
            <div class="flex" style="margin-top:16px">
              <button id="cnhSelectAll">Selecionar Todos</button>
              <button id="cnhClear" class="ghost">Desmarcar Todos</button>
            </div>
          </div>

          <div id="blkGeneric" class="card hidden" style="background:#0a1224; margin-top:16px">
            <h4 style="margin:0 0 12px 0">Par√¢metros de Execu√ß√£o</h4>
            <div class="flex">
              <input id="genericLojas" class="input" placeholder="Lojas (separadas por v√≠rgula)" style="flex:1"/>
              <input id="genericUrl" class="input" placeholder="URL (opcional)" style="flex:1"/>
            </div>
            <div class="flex" style="margin-top:8px">
              <input id="genericData" class="input" placeholder="Data (opcional)" style="flex:1"/>
              <input id="genericPasta" class="input" placeholder="Pasta destino (opcional)" style="flex:1"/>
            </div>
          </div>

          <div class="flex" style="margin-top:16px; justify-content:flex-end">
            <button id="btnRun" disabled>Executar</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="card w-30">
          <h3>Status</h3>
          <div class="hr"></div>
          <div class="logbox" id="statusLog"></div>
        </div>
        <div class="card w-30">
          <h3>Sa√≠das</h3>
          <div class="hr"></div>
          <div class="logbox" id="outputsLog"></div>
        </div>
      </div>

      <div class="row">
        <div class="card w-80">
          <h3>√öltimas execu√ß√µes</h3>
          <div class="hr"></div>
          <div class="logbox" id="historyLog" style="height:220px"></div>
        </div>
      </div>

    </div>
  </main>

  <footer>
    <div class="footer-in">
      <div>Todos os direitos reservados ao Grupo Linhares. Fortaleza 2025</div>
      <div class="pill">Dev ‚Ä¢ Teste local com CORS</div>
    </div>
  </footer>
</div>

<script>
  const LS_KEYS = { baseUrl:'liliauto_base_url', jwt:'liliauto_jwt', user:'liliauto_user', autosPath:'liliauto_autos_path' };

  const statusLog = document.getElementById('statusLog');
  const outputsLog = document.getElementById('outputsLog');
  const historyLog = document.getElementById('historyLog');
  const execInfo = document.getElementById('execInfo');
  const endpointHelper = document.getElementById('endpointHelper');

  const elUser = document.getElementById('userInput');
  const elBase = document.getElementById('baseUrl');
  const elJwt  = document.getElementById('jwt');
  const elDeps = document.getElementById('departments');
  const elAutos = document.getElementById('automations');
  const elAutosPath = document.getElementById('automationsPath');
  const btnRun = document.getElementById('btnRun');

  const fileInput = document.getElementById('fileInput');
  const extraParams = document.getElementById('extraParams');

  const blkCDC = document.getElementById('blkCDC');
  const blkCNH = document.getElementById('blkCNH');
  const blkGeneric = document.getElementById('blkGeneric');

  // Campos gen√©ricos
  const genericLojas = document.getElementById('genericLojas');
  const genericUrl = document.getElementById('genericUrl');
  const genericData = document.getElementById('genericData');
  const genericPasta = document.getElementById('genericPasta');

  let automationMap = [];

  // Mapeamento de endpoints espec√≠ficos
  const ENDPOINT_MAP = {
    'conciliacao-cdc-honda': '/conciliacao-cdc-honda',
    'baixa-arquivos-cnh-honda': '/baixa-arquivos-cnh-honda',
    'solicitacao-carga': '/solicitacao-carga',
    'preparacao-baixas': '/preparacao-baixas',
    'aymore': '/aymore/processar-dados',
    'abrir-driver': '/abrir-driver'
  };

  const log = (where, msg, obj=null)=>{
    const time = new Date().toLocaleString();
    let html = `<div><span class="pill" style="margin-right:8px">${time}</span>${msg}</div>`;
    if(obj){
      const pre = document.createElement('pre');
      pre.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
      where.appendChild(document.createRange().createContextualFragment(html));
      where.appendChild(pre);
    }else{
      where.insertAdjacentHTML('beforeend', html);
    }
    where.scrollTop = where.scrollHeight;
  };

  const authHeader = ()=>{
    const token = localStorage.getItem(LS_KEYS.jwt) || elJwt.value.trim();
    return token ? { 'Authorization': `Bearer ${token}` } : {};
  };

  const getBase = ()=> (localStorage.getItem(LS_KEYS.baseUrl) || elBase.value.trim() || '');
  const getAutosPath = ()=> (localStorage.getItem(LS_KEYS.autosPath) || elAutosPath.value.trim() || '/toFront/automations');

  const savePersist = ()=>{
    localStorage.setItem(LS_KEYS.user, elUser.value.trim());
    localStorage.setItem(LS_KEYS.baseUrl, elBase.value.trim());
    localStorage.setItem(LS_KEYS.jwt, elJwt.value.trim());
    localStorage.setItem(LS_KEYS.autosPath, elAutosPath.value.trim());
    log(statusLog, '‚úÖ Prefer√™ncias salvas localmente (LocalStorage).');
  };

  const loadPersist = ()=>{
    const u = localStorage.getItem(LS_KEYS.user); if(u) elUser.value = u;
    const b = localStorage.getItem(LS_KEYS.baseUrl); if(b) elBase.value = b;
    const j = localStorage.getItem(LS_KEYS.jwt); if(j) elJwt.value = j;
    const ap = localStorage.getItem(LS_KEYS.autosPath); if(ap) elAutosPath.value = ap;
  };

  const clearPersist = ()=>{
    Object.values(LS_KEYS).forEach(k=> localStorage.removeItem(k));
    elUser.value = 'nome.sobrenome'; elBase.value='http://127.0.0.1:5000'; elJwt.value=''; elAutosPath.value='/toFront/automations';
    log(statusLog, 'üîí Voc√™ saiu. Os campos foram limpos.');
  };

  const apiGet = async (path)=>{
    const base = getBase();
    if(!base) throw new Error('Base URL vazia.');
    const url = base.replace(/\/$/,'') + path;
    const res = await fetch(url, { headers: { 'Accept':'application/json', ...authHeader() } });
    const text = await res.text();
    let data = null; try{ data = text ? JSON.parse(text) : null } catch{ data = { raw:text } }
    if(!res.ok){
      const err = new Error(`GET ${url} -> ${res.status} ${res.statusText}`);
      err.status = res.status; err.response = data || text; throw err;
    }
    return { res, data };
  };

  const apiPostForm = async (path, formData)=>{
    const base = getBase();
    const url = base.replace(/\/$/,'') + path;
    const headers = { ...authHeader() };
    const res = await fetch(url, { method:'POST', headers, body: formData });
    const text = await res.text();
    let data = null; try{ data = text ? JSON.parse(text) : null } catch{ data = { raw:text } }
    if(!res.ok){
      const err = new Error(`POST ${url} -> ${res.status} ${res.statusText}`);
      err.status = res.status; err.response = data || text; throw err;
    }
    return { res, data };
  };

  const apiPostJson = async (path, jsonData)=>{
    const base = getBase();
    const url = base.replace(/\/$/,'') + path;
    const res = await fetch(url, { 
      method:'POST', 
      headers: { 'Content-Type':'application/json', ...authHeader() },
      body: JSON.stringify(jsonData)
    });
    const text = await res.text();
    let data = null; try{ data = text ? JSON.parse(text) : null } catch{ data = { raw:text } }
    if(!res.ok){
      const err = new Error(`POST ${url} -> ${res.status} ${res.statusText}`);
      err.status = res.status; err.response = data || text; throw err;
    }
    return { res, data };
  };

  const loadDepartments = async ()=>{
    elDeps.disabled = true; elDeps.innerHTML = `<option>Carregando...</option>`;
    try{
      const { data, res } = await apiGet('/toFront/departments');
      const items = Array.isArray(data) ? data : (data?.departments || data?.data || data?.items || []);
      elDeps.innerHTML = `<option value="">Selecione...</option>` + items.map(o=>`<option value="${o.id||o.name}">${o.name||o.id}</option>`).join('');
      elDeps.disabled = false;
      log(statusLog, '‚úÖ Departamentos carregados.', { status: res.status, items });
    }catch(err){
      elDeps.innerHTML = `<option value="">Erro ao carregar</option>`;
      log(statusLog, '‚ùå Erro ao carregar departamentos.', { error: String(err), status: err?.status, response: err?.response });
    }
  };

  const buildAutosPath = (departmentId)=>{
    let p = getAutosPath().trim();
    if(!p.endsWith('/')) p += '/';
    return p + encodeURIComponent(departmentId);
  };

  const loadAutomations = async (departmentId)=>{
  elAutos.disabled = true; 
  elAutos.innerHTML = `<option>Carregando...</option>`;
  const path = buildAutosPath(departmentId);
  
  try{
    const { data, res } = await apiGet(path);
    
    // DEBUG: Log a resposta completa para vermos a estrutura
    console.log('Resposta da API de automa√ß√µes:', data);
    
    // CORRE√á√ÉO: Acessa a propriedade correta baseada no seu backend
    let list = [];
    
    if (data && data.items) {
      // Se a resposta tem a estrutura { items: [...] }
      list = data.items;
    } else if (Array.isArray(data)) {
      // Se a resposta √© diretamente um array
      list = data;
    } else if (data && Array.isArray(data.automations)) {
      // Se a resposta tem a estrutura { automations: [...] }
      list = data.automations;
    } else if (data && Array.isArray(data.data)) {
      // Se a resposta tem a estrutura { data: [...] }
      list = data.data;
    }
    
    log(statusLog, '‚ÑπÔ∏è Estrutura da resposta:', { 
      hasItems: !!data?.items,
      isArray: Array.isArray(data),
      itemCount: list.length,
      keys: data ? Object.keys(data) : 'no data'
    });

    automationMap = list.map(o=>{
      const id = o?.id ?? o?.automation_id ?? o?.code ?? 'unknown';
      const name = o?.name ?? o?.title ?? String(id);
      const type = o?.type || 'generic';
      return { 
        id: String(id), 
        name: String(name), 
        type, 
        raw: o 
      };
    });

    // Se n√£o encontrou automa√ß√µes, mostra uma mensagem
    if (automationMap.length === 0) {
      elAutos.innerHTML = `<option value="">Nenhuma automa√ß√£o encontrada</option>`;
      log(statusLog, '‚ö†Ô∏è Nenhuma automa√ß√£o encontrada para este departamento.');
    } else {
      elAutos.innerHTML = `<option value="">Selecione uma automa√ß√£o...</option>` + 
        automationMap.map(o=>`<option value="${o.id}">${o.name}</option>`).join('');
    }
    
    elAutos.disabled = false;
    updateExecSummary();
    showHideBlocks();
    log(statusLog, '‚úÖ Automa√ß√µes carregadas.', { 
      status: res.status, 
      count: automationMap.length,
      automa√ß√µes: automationMap.map(a => ({ id: a.id, name: a.name }))
    });
    
  }catch(err){
    elAutos.innerHTML = `<option value="">Erro ao carregar</option>`;
    log(statusLog, '‚ùå Erro ao carregar automa√ß√µes.', { 
      error: String(err), 
      status: err?.status, 
      response: err?.response 
    });
    
    // Fallback para desenvolvimento - automa√ß√µes mock
    automationMap = [
      {id:'conciliacao-cdc-honda', name:'Concilia√ß√£o CDC Honda', type:'cdc', raw:{} },
      {id:'baixa-arquivos-cnh-honda', name:'Baixas CNH Honda', type:'cnh', raw:{} },
      {id:'solicitacao-carga', name:'Solicita√ß√£o de Carga CNH', type:'generic', raw:{} },
      {id:'preparacao-baixas', name:'Prepara√ß√£o de Baixas', type:'generic', raw:{} },
      {id:'abrir-driver', name:'Abrir Driver', type:'generic', raw:{} },
    ];
    
    elAutos.innerHTML = `<option value="">Selecione uma automa√ß√£o...</option>` + 
      automationMap.map(o=>`<option value="${o.id}">${o.name}</option>`).join('');
    elAutos.disabled = false;
    updateExecSummary();
    showHideBlocks();
  }
};

  const updateExecSummary = ()=>{
    const dep = elDeps.value || '‚Äî';
    const autoId = elAutos.value || '‚Äî';
    const autoObj = automationMap.find(a=>a.id===autoId);
    const autoName = autoObj?.name || '‚Äî';
    
    // Determina o endpoint baseado no ID da automa√ß√£o
    let endpoint = ENDPOINT_MAP[autoId] || `/toFront/automations/${autoId}/run`;
    let method = 'POST';
    let helperText = `Endpoint: ${method} ${endpoint}`;

    // Ajustes espec√≠ficos para cada automa√ß√£o
    if (autoId === 'conciliacao-cdc-honda') {
      endpoint += '/{lojas}';
      helperText = `Endpoint: POST ${endpoint} - Par√¢metro de lojas na URL`;
    } else if (autoId === 'baixa-arquivos-cnh-honda') {
      endpoint += '/{lojas}';
      helperText = `Endpoint: POST ${endpoint} - Par√¢metro de lojas na URL`;
    } else if (autoId === 'solicitacao-carga') {
      endpoint += '/{lojas}';
      helperText = `Endpoint: GET ${endpoint} - Par√¢metro de lojas na URL`;
    } else if (autoId === 'abrir-driver') {
      method = 'GET';
      helperText = `Endpoint: GET ${endpoint} - Abre inst√¢ncia do driver`;
    }

    document.getElementById('execEndpoint').innerHTML = `<code>${method} ${endpoint}</code>`;
    endpointHelper.textContent = helperText;
    
    execInfo.innerHTML = "";
    log(execInfo, `dep: <b>${dep}</b> ‚Ä¢ autoId: <b>${autoId}</b> ‚Ä¢ auto: <b>${autoName}</b>`);

    btnRun.disabled = !(elDeps.value && elAutos.value);
  };

  const parseExtraParams = ()=>{
    const lines = (extraParams.value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const obj = {};
    for(const line of lines){
      const ix = line.indexOf('=');
      if(ix>0){
        const k = line.slice(0,ix).trim();
        const v = line.slice(ix+1).trim();
        obj[k]=v;
      }
    }
    return obj;
  };

  const runExecution = async ()=>{
    const depId = elDeps.value;
    const autoId = elAutos.value;
    if(!depId || !autoId){
      alert('Selecione a √°rea de neg√≥cio e a automa√ß√£o.');
      return;
    }

    const autoObj = automationMap.find(a=>a.id===autoId);
    const autoName = autoObj?.name || '';

    try {
      let result;
      
      // L√≥gica espec√≠fica para cada tipo de automa√ß√£o
      if (autoId === 'conciliacao-cdc-honda') {
        const lojas = Array.from(document.querySelectorAll('#cdcChecks input[type="checkbox"]:checked')).map(i=>i.value).join(',');
        if (!lojas) {
          alert('Selecione pelo menos uma loja para Concilia√ß√£o CDC Honda.');
          return;
        }
        const path = `/conciliacao-cdc-honda/${encodeURIComponent(lojas)}`;
        log(statusLog, `üöÄ Executando Concilia√ß√£o CDC Honda...`, { lojas });
        result = await apiPostJson(path, {});

      } else if (autoId === 'baixa-arquivos-cnh-honda') {
        const lojas = Array.from(document.querySelectorAll('#cnhChecks input[type="checkbox"]:checked')).map(i=>i.value).join(',');
        if (!lojas) {
          alert('Selecione pelo menos uma loja para Baixas CNH Honda.');
          return;
        }
        const path = `/baixa-arquivos-cnh-honda/${encodeURIComponent(lojas)}`;
        log(statusLog, `üöÄ Executando Baixas CNH Honda...`, { lojas });
        result = await apiPostJson(path, {});

      } else if (autoId === 'solicitacao-carga') {
        const lojas = genericLojas.value || Array.from(document.querySelectorAll('#cnhChecks input[type="checkbox"]:checked')).map(i=>i.value).join(',');
        if (!lojas) {
          alert('Informe as lojas para Solicita√ß√£o de Carga.');
          return;
        }
        const path = `/solicitacao-carga/${encodeURIComponent(lojas)}`;
        log(statusLog, `üöÄ Executando Solicita√ß√£o de Carga...`, { lojas });
        result = await apiGet(path);

      } else if (autoId === 'abrir-driver') {
        log(statusLog, `üöÄ Abrindo inst√¢ncia do driver...`);
        result = await apiGet('/abrir-driver');

      } else if (autoId === 'preparacao-baixas') {
        const lojas = genericLojas.value;
        if (!lojas) {
          alert('Informe o nome da loja para Prepara√ß√£o de Baixas.');
          return;
        }
        const tipo = extraParams.value.includes('verifica_dados_linx') ? 'verifica_dados_linx' : 'extrair-pdf';
        const path = `/preparacao-baixas/${tipo}/${encodeURIComponent(lojas)}`;
        log(statusLog, `üöÄ Executando Prepara√ß√£o de Baixas...`, { lojas, tipo });
        result = await apiPostJson(path, {});

      } else if (autoId === 'aymore') {
        log(statusLog, `üöÄ Processando dados Aymore...`);
        result = await apiPostJson('/aymore/processar-dados', {});

      } else {
        // Automa√ß√£o gen√©rica via FormData
        const fd = new FormData();
        fd.append('departmentId', depId);

        const extras = parseExtraParams();
        Object.entries(extras).forEach(([k,v])=> fd.append(k, v));

        const files = fileInput.files;
        for(const file of files){
          fd.append('files[]', file, file.name);
        }

        const path = `/toFront/automations/${encodeURIComponent(autoId)}/run`;
        log(statusLog, 'üöÄ Executando automa√ß√£o gen√©rica...', { path });
        result = await apiPostForm(path, fd);
      }

      const { data, res } = result;
      log(statusLog, '‚úÖ Execu√ß√£o conclu√≠da.', { status: res.status, data });
      log(historyLog, 'üßæ Hist√≥rico ‚Ä¢ Execu√ß√£o registrada.', { automation: autoName, response: data });

      if(data && (data.files || data.links || data.resultado)){
        const out = [];
        if(data.files) (data.files||[]).forEach(f=> out.push(`<div>Arquivo: <a class="link" href="${f.url}" target="_blank" rel="noopener">${f.name||f.url}</a></div>`));
        if(data.links) (data.links||[]).forEach(u=> out.push(`<div>Link: <a class="link" href="${u}" target="_blank" rel="noopener">${u}</a></div>`));
        if(data.resultado) out.push(`<div>Resultado: ${JSON.stringify(data.resultado)}</div>`);
        outputsLog.insertAdjacentHTML('afterbegin', out.join(''));
      }else{
        outputsLog.insertAdjacentHTML('afterbegin', `<div>Resposta: ${JSON.stringify(data)}</div>`);
      }

    }catch(err){
      log(statusLog, '‚ùå Falha ao executar.', { error: String(err), status: err?.status, response: err?.response });
      alert('Falha ao executar. Veja o log.');
    }
  };

  const showHideBlocks = ()=>{
    const autoId = elAutos.value;
    const obj = automationMap.find(a=>a.id===autoId);
    const name = obj?.name || '';

    // Esconde todos os blocos primeiro
    blkCDC.classList.add('hidden');
    blkCNH.classList.add('hidden');
    blkGeneric.classList.add('hidden');

    // Mostra o bloco apropriado
    if(/Concilia√ß√£o CDC Honda/i.test(name) || autoId === 'conciliacao-cdc-honda') {
      blkCDC.classList.remove('hidden');
    } else if(/Baixas CNH Honda/i.test(name) || autoId === 'baixa-arquivos-cnh-honda') {
      blkCNH.classList.remove('hidden');
    } else if(['solicitacao-carga', 'preparacao-baixas'].includes(autoId)) {
      blkGeneric.classList.remove('hidden');
    }
  };

  // Event Listeners
  document.getElementById('btnSave').addEventListener('click', async ()=>{
    savePersist();
    await loadDepartments();
  });

  document.getElementById('btnLogout').addEventListener('click', ()=>{
    clearPersist();
    elDeps.innerHTML = `<option value="">‚Äî</option>`; elDeps.disabled = true;
    elAutos.innerHTML = `<option value="">‚Äî</option>`; elAutos.disabled = true;
    btnRun.disabled = true;
    execInfo.innerHTML = '';
    updateExecSummary();
  });

  elDeps.addEventListener('change', (e)=>{
    const id = e.target.value; 
    if(id) loadAutomations(id);
    updateExecSummary();
  });

  elAutos.addEventListener('change', ()=>{ 
    updateExecSummary(); 
    showHideBlocks(); 
  });

  btnRun.addEventListener('click', runExecution);

  // Checkboxes para CDC e CNH
  const cdcChecks = document.getElementById('cdcChecks');
  const cnhChecks = document.getElementById('cnhChecks');
  
  const fillChecks = (el, items)=>{
    el.innerHTML = '';
    items.forEach(v=>{
      const lab = document.createElement('label');
      lab.innerHTML = `<input type="checkbox" value="${v}"/> ${v}`;
      el.appendChild(lab);
    });
  };

  document.getElementById('cdcSelectAll').addEventListener('click', ()=> cdcChecks.querySelectorAll('input').forEach(i=> i.checked=true));
  document.getElementById('cdcClear').addEventListener('click', ()=> cdcChecks.querySelectorAll('input').forEach(i=> i.checked=false));
  document.getElementById('cnhSelectAll').addEventListener('click', ()=> cnhChecks.querySelectorAll('input').forEach(i=> i.checked=true));
  document.getElementById('cnhClear').addEventListener('click', ()=> cnhChecks.querySelectorAll('input').forEach(i=> i.checked=false));

  // Inicializa√ß√£o
  (function init(){
    loadPersist();
    const cdc = ['ARES - MOTOS - JUAZEIRO','ARES - MOTOS - CRATO','TERRA SANTA - MOTOS - CANIND√â','NOVA ONDA - MOTOS - ARACATI'];
    const cnh = ['ARES - MOTOS - ACM','ARES - MOTOS - IGUATU','ARES - MOTOS - SALVADOR - BONOC√î','ARES - MOTOS - BREJO SANTO','ARES - MOTOS - CAL√áADA','ARES - MOTOS - CRATO','ARES - MOTOS - CRUZ DAS ALMAS','ARES - MOTOS - ICO','ARES - MOTOS - IPU','ARES - MOTOS - ITAPAJ√â','ARES - MOTOS - ITAPIPOCA','ARES - MOTOS - JUAZEIRO','ARES - MOTOS - LITORAL','NOVA ONDA - MOTOS - ARACATI','NOVA ONDA - MOTOS - IGUATU','NOVA ONDA - MOTOS - LIMOEIRO','TERRA SANTA - MOTOS - CANIND√â','ARES - MOTOS - TIANGUA','ARES - MOTOS - VALEN√áA','ARES - MOTOS - CAMPO SALES'];
    fillChecks(cdcChecks, cdc);
    fillChecks(cnhChecks, cnh);
    updateExecSummary();
    
    // Carrega departamentos automaticamente ao iniciar
    setTimeout(() => loadDepartments(), 500);
  })();
</script>
</body>
</html>